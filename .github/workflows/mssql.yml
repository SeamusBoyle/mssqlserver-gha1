on:
  - pull_request
  - push

name: build

jobs:
  tests:
    runs-on: ubuntu-latest
    name: example
    # container:
    #   image: node:18
    #   options: --cap-add=NET_ADMIN
    #   ports:
    #     - 1433

    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2017-latest
        env:
          SA_PASSWORD: YourStrong!Passw0rd
          ACCEPT_EULA: Y
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: --name=mssql --health-cmd="/opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'YourStrong!Passw0rd' -Q 'SELECT 1'" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Create MS SQL Database
        run: |
          apt update && apt install sudo

          curl https://packages.microsoft.com/keys/microsoft.asc -o microsoft.asc && \
          gpg --no-default-keyring --keyring ./msft-archive-keyring.gpg --import ./microsoft.asc && \
          cp ./msft-archive-keyring.gpg /usr/share/keyrings/ && \
          curl https://packages.microsoft.com/config/debian/12/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo sed -i 's/signed-by=\/usr\/share\/keyrings\/microsoft-prod.gpg//' /etc/apt/sources.list.d/mssql-release.list
          echo "deb [signed-by=/usr/share/keyrings/msft-archive-keyring.gpg] https://packages.microsoft.com/ubuntu/22.04/prod jammy main" | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17
          # optional: for bcp and sqlcmd
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools
          echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc
          bash ~/.bashrc
          
          sudo apt-get update && sudo apt-get install -y mssql-tools
          /opt/mssql-tools/bin/sqlcmd -S localhost,1433 -U SA -P 'YourStrong!Passw0rd' -b -Q 'CREATE DATABASE test_db'
          cat << EOF > test1.sql
          CREATE TABLE Persons (
              PersonID int,
              LastName varchar(255),
              FirstName varchar(255),
              Address varchar(255),
              City varchar(255)
          );
          EOF
          /opt/mssql-tools/bin/sqlcmd -S localhost,1433 -U SA -P 'YourStrong!Passw0rd' -b -i test1.sql
          /opt/mssql-tools/bin/sqlcmd -S localhost,1433 -U SA -P 'YourStrong!Passw0rd' -b -Q 'SELECT * FROM test_db1.dbo.Persons'
